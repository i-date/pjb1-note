# VBAのエラー

## 基本

- 3種類
  1. コンパイルエラー
     - タイミング: 主にコードの記述中
     - エラーが生じる→実行待機状態
     - ツールバーのリセットボタンで実行待機状態を解除して修正
  2. 実行時エラー
     - タイミング: 実際に試してみたら駄目だったコード
     - ダイアログの終了を押すと、マクロ実行を終了
     - エラーが発生したステートメントよりも前は実行されている
     - 巻き戻しセットアップが簡単にできるように癖をつける
  3. 論理エラー
     - エラーが発生することなく終了はするが、結果が意図していたものと異なる

- 実行待機状態
  - 各種プロパティの値や変数の値などを保持している状態
  - イミディエイトウインドウで`? 変数名`などで確認できる
  - 表示→ローカルウィンドウ: 利用している変数と値の一覧を確認できる
  - 表示→ウォッチウィンドウ: 注目したい変数や式を登録してピックアップ監視ができる
- ステップ実行: 一行ずつコードを実行
  - デバッグ→ステップイン、もしくはF8
  - 継続ボタンで残りをすべて実行、リセットボタンでマクロを中断
- ブレークポイント
  - コード左端のインジケーターバーをクリックして設定
  - マクロを実行すると、ブレークポイントで実行待機状態になる
  - Excelを閉じるとクリアされる
- Stop/Assertステートメント
  - Excelを閉じても保持される
  - `Stop`: 書くブレークポイント
  - `Debug.Assert 停止条件`: 指定条件を満たさない場合のみ実行待機状態になる

## エラートラップ

```vba
Sub 名前()
  On Error GoTo ラベル名
  '以降にエラーが生じる可能性があるコードを記述
  'エラーが生じるとラベル名に記述した処理を実行
  
  '途中でエラートラップを解除する場合は下記を記述
  On Error GoTo 0
  
  'エラーを無視する場合は下記を記述すると、以降のコードはエラーが無視される
  On Error GoTo Resume Next
Exit Sub

ラベル名:
'ここにエラー発生時に実行するコード

'再実行関連は下記のコード
Resume 'エラーが発生したコードから再実行
Resume Next 'エラーが発生したコードの次のステートメントから再実行
```

- 基本の考え方
  - `On Error GoTo ラベル名`でトラップ開始
  - `Exit Sub`まで通常処理、ラベル以降はエラー処理
  - エラー情報は、Errオブジェクトを介してチェック
- Errオブジェクトで頻繁に使用するプロパティ
  - Number: エラーの種類に応じたエラー番号
  - Description: エラー発生時に表示されるメッセージ
- エラー確認用のアイディア
  - 開発中は`Debug.Print`を仕込んでおく
  - マクロ名や気になる値を出力(ループ内で値をチェックなど)
  - 修正オペレーション用の目印を用意(定数でID作って出力など)
  - 量が膨大なら、テキストファイルに出力
- デバッグ用コードの削除
  - 編集→置換(パターンマッチング: `Debug*`→`""`)
- 最終手段
  - Escキー
  - タスクマネージャー
