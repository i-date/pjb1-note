# VBAのマクロのパーツ化とユーザー定義関数

## サブルーチン(演算のみ、値やオブジェクトを返さない)

- VBAの引数ルール
  1. 戻り値受け取る: 引数を`()`で囲まない
  2. 戻り値受け取らない: 引数を`()`で囲む
  3. 強制値渡し: 引数ごとに`()`で囲む

  ```vba
  '戻り値なし
  MsgBox "VBA"   '第一引数を参照渡し
  MsgBox ("VBA") '第一引数を強制値渡し
  
  '戻り値あり
  foo = MsgBox("ok?", vbYesNo)   '第一引数を参照渡し
  foo = MsgBox(("ok?"), vbYesNo) '第一引数を強制値渡し
  ```

- 呼び出し
  - `Call マクロ名(引数)`

- 呼び出されるマクロ

  ```vba
  Sub マクロ名([Optional] 引数 As 型 = デフォルト値)
    処理
  End Sub
  ```

- 参照渡し(デフォルト)と値渡し
  - 参照: `Sub マクロ名(ByRef 引数 As 型)`
    - Call先で値を変更された場合: 値を持ち帰る
  - 値: `Sub マクロ名(ByVal 引数 As 型)`
    - Call先で値を変更された場合: 値を持ち帰らない
    - 呼び出し時に二重括弧で強制値渡しを指定: `Call マクロ名((引数))`

- 不特定多数の引数、パラメータ配列

  ```vba
  'マクロ側
  Sub マクロ名(ParamArray 配列名() As Variant)
  
  '呼び出し側
  Call マクロ名(引数1, 引数2, ...)
  ```

## ユーザー定義関数(値やオブジェクトを返す)

- Functionで宣言
- 引数はSubプロシージャと同様の記述
- 関数名定義の際、戻り値の型も指定できる
- `関数名 = 戻り値`の形で、関数名と同じ識別子に代入された値が戻り値となる
- 呼び出し
  1. そのまま関数名から記述
  2. Callステートメントを使用
  3. ワークシート関数として呼び出し(注意)
     - 基本は`Private`をつけてワークシート関数として呼び出さない
     - 明示的に`Public`をつけてワークシート関数として呼び出せるようにする

```vba
Private Function 関数名(引数) As 戻り値の型 任意の処理
  '戻り値: 値
  関数名 = 戻り値
  
  '戻り値: オブジェクト
  Set 関数名 = 戻り値
End Function
```

## カスタムオブジェクト

- 目的: データ(プロパティ)とふるまい(メソッド)をまとめる
- クラスモジュールを使用
- オブジェクト名はプロパティウィンドウの`(オブジェクト名)`で確認/変更
- クラスモジュール内では、Meキーワードで「オブジェクト自身」にアクセスできる
  - 例: `Me.Name`→オブジェクト自身のNameプロパティにアクセス
- 作成したオブジェクトを使用する際は`New`演算子を使用、`変数 = New オブジェクト`
- コンストラクタ関数はVBAには存在しない
  - 代替1: Initializeイベントを利用
  - 代替2: 独自の初期化メソッド(例えばInit)を用意、運用時にNew→Init
  - 代替3: 標準モジュールに新規オブジェクトを作成する専用の関数を用意する

- プロパティとメソッドの作成方法
  - プロパティ: クラスモジュール内で、Publicステートメントを使用
  - メソッド: クラスモジュール内で、Publicステートメント、Subプロシージャ、Functionプロシージャを使用

  ```vba
  'プロパティ
  Public プロパティ名 As 型
  
  'カプセル化プロパティ
  Private プロパティ名 As 型
  
  'メソッド
  Public Sub メソッド名(引数)
    '処理
  End Sub
  
  Public Function メソッド名(引数) As 戻り値の型 任意の処理
    '処理
  End Sub
  ```

- Getter/Setter: Propertyプロシージャを使用

  ```vba
  'Getter
  Public Property Get プロパティ名() As 型
    プロパティ名 = カプセル化プロパティ名
  End Property
  
  'Setter
  Public Property Let プロパティ名(引数)
    '引数のチェック/エラー処理
    '値のセット
    カプセル化プロパティ名 = 値
  End Property
  ```

## 構造体

- 目的: データのみをまとめて扱う
- 標準モジュールの冒頭にTypeステートメントを使用して記述
- 変数や配列のデータ型として利用可能

```vba
Type 構造体名
  プロパティ名1 As 型
  プロパティ名2 As 型
End Type

Dim 配列名(要素数) As 構造体名
配列名(0).プロパティ名1 = 値
配列名(0).プロパティ名2 = 値
配列名(1).プロパティ名1 = 値
配列名(1).プロパティ名2 = 値
```

## 継承

- オブジェクトの継承は用意されていない
- インターフェイスの継承のみある
- インターファースである親の型の変数や配列に代入できる

```vba
'親インターフェイス継承
Implements 親インターフェイス
'独自プロパティの定義
'インターフェイスで実装されたプロパティをGetter/Setterで実装
Private Property Get インターフェイス名_プロパティ() As 型
Private Property Let インターフェイス名_プロパティ(引数)
Public Function インターフェイス名_メソッド名(引数) As 戻り値の型 任意の処理
  '処理
End Function
```
